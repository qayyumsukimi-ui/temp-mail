<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inbox @ aqas.space</title>
  <style>
    :root{--bg:#0b0f14;--panel:#111827;--muted:#6b7280;--text:#e5e7eb;--accent:#38bdf8;--danger:#ef4444}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    header{padding:18px 20px;border-bottom:1px solid #1f2937;background:linear-gradient(180deg,#0d131a,#0b0f14)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    h1{font-size:18px;margin:0;color:#fff}
    .muted{color:var(--muted)}
    input,button{height:44px;border-radius:12px;border:1px solid #233042;background:#0f172a;color:#e5e7eb;padding:0 14px}
    button{cursor:pointer}
    button.primary{background:#0ea5e9;border-color:#0ea5e9}
    button:disabled{opacity:.6;cursor:not-allowed}
    .inbox{max-height:62vh;overflow:auto}
    .item{padding:12px 14px;border-bottom:1px solid #1f2937;display:grid;grid-template-columns:220px 1fr 160px;gap:10px}
    .item:hover{background:#0f172a}
    .subject{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #1f2937;color:#93c5fd;font-size:12px}
    .viewer{padding:14px;max-height:62vh;overflow:auto}
    .badge{border:1px solid #1f2937;border-radius:10px;padding:6px 10px;display:inline-block;margin-right:8px}
    .footer{padding:12px 18px;color:#9ca3af;font-size:12px}
    a{color:#93c5fd}
    .bar{display:flex;gap:8px;align-items:flex-end}
    .hint{font-size:12px;color:#9ca3af;margin-top:6px}
    .danger{color:#fecaca}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Mail Inbox (Alias Mode)</h1>
        <div class="muted">Each URL shows only one alias inbox. Example: <code>#/inbox/test123@aqas.space</code></div>
      </div>
      <div class="muted" id="status">Disconnected</div>
    </div>
  </header>

  <div class="wrap">
    <div class="card" style="padding:18px;margin-bottom:16px">
      <div class="row">
        <div class="col">
          <label class="muted">API Server</label>
          <!-- Tukar ke https://api.aqas.space/api/v1/ bila reverse proxy SSL siap -->
          <input id="api" value="http://89.116.30.158:8025/api/v1/" />
          <div class="hint">If your UI is served over HTTPS, set this to an <b>HTTPS</b> endpoint (e.g. <code>https://api.aqas.space/api/v1/</code>) to avoid mixed content.</div>
        </div>
        <div class="col">
          <label class="muted">Alias (email)</label>
          <input id="alias" placeholder="test123@aqas.space" />
          <div class="hint">Alias is read from URL hash too: <code>#/inbox/&lt;email&gt;</code></div>
        </div>
        <div class="col bar">
          <button class="primary" id="btnLoad">Load</button>
          <button id="btnCopy">Copy share URL</button>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col card inbox" id="list"></div>
      <div class="col card viewer" id="viewer">Select a messageâ€¦</div>
    </div>

    <div class="footer">Powered by Mailpit API â€¢ This UI is a single static file for Cloudflare Pages.</div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s)
    const fmtDate = (iso)=> new Date(iso||Date.now()).toLocaleString()

    // #/inbox/<alias>
    function aliasFromHash(){
      const m = location.hash.match(/#\/inbox\/(.+)$/)
      return m? decodeURIComponent(m[1]) : ''
    }
    function setStatus(t){ $('#status').textContent = t }

    async function fetchJSON(url){
      const r = await fetch(url,{headers:{'accept':'application/json'}})
      if(!r.ok) throw new Error('HTTP '+r.status)
      return r.json()
    }

    async function loadList(){
      const api = $('#api').value.replace(/\/?$/,'/')
      const alias = $('#alias').value.trim()
      if(!alias){ alert('Enter alias email'); return }
      setStatus('Loadingâ€¦')
      const q = encodeURIComponent('to:"'+alias+'"')
      const url = api + 'messages?query=' + q + '&limit=100'
      try{
        const data = await fetchJSON(url)
        const list = data.messages || data || []
        if(!Array.isArray(list)) throw new Error('Unexpected API response')
        renderList(list, api)
        setStatus('Connected')
      }catch(e){
        setStatus('Error')
        $('#list').innerHTML = `<div style="padding:14px" class="danger">Failed to load: ${e.message}.<br/>If you see a CORS or Mixed Content error, run Mailpit with <code>--cors-origin '*'</code> and use an <b>HTTPS</b> reverse proxy domain for the API.</div>`
      }
      history.replaceState(null,'', `#/inbox/${encodeURIComponent(alias)}`)
    }

    function renderList(items, api){
      if(items.length===0){
        $('#list').innerHTML = '<div style="padding:14px" class="muted">No messages for this alias yet.</div>'
        $('#viewer').textContent='Select a messageâ€¦'
        return
      }
      $('#list').innerHTML = items.map(m=>{
        const from = (m.from && (m.from.name||m.from.address)) || (m.From||'')
        const subj = m.subject || m.Subject || '(no subject)'
        const date = m.created || m.Date || m.date
        return `<div class="item" data-id="${m.id}">
          <div><span class="pill">${from?from.replace(/</g,'&lt;'):'unknown'}</span></div>
          <div class="subject">${subj.replace(/</g,'&lt;')}</div>
          <div class="muted">${fmtDate(date)}</div>
        </div>`
      }).join('')

      $('#list').querySelectorAll('.item').forEach(el=>{
        el.addEventListener('click', ()=>loadOne(el.dataset.id, api))
      })
    }

    async function loadOne(id, api){
      setStatus('Loading messageâ€¦')
      try{
        const msg = await fetchJSON(api + 'message/' + id)
        const html = msg.html || msg.HTML || ''
        const text = msg.text || msg.Text || ''
        const att = (msg.attachments||[])
        $('#viewer').innerHTML = `
          <div style="margin-bottom:8px">
            <span class="badge">From: ${(msg.from && (msg.from.name||msg.from.address)) || ''}</span>
            <span class="badge">To: ${(msg.to && msg.to.map(t=>t.address).join(', ')) || ''}</span>
          </div>
          <h2 style="margin:4px 0 10px">${(msg.subject||'(no subject)').replace(/</g,'&lt;')}</h2>
          <div class="muted" style="margin-bottom:10px">${fmtDate(msg.created)}</div>
          ${html ? `<iframe sandbox="allow-same-origin" style="width:100%;height:52vh;border:0;background:#000" srcdoc="${html.replace(/"/g,'&quot;')}"></iframe>` : `<pre style="white-space:pre-wrap">${(text||'').replace(/</g,'&lt;')}</pre>`}
          ${att.length? `<div style="margin-top:10px">${att.map(a=>`<span class='badge'>ðŸ“Ž ${a.filename||a.contentId||'attachment'} (${a.size||''})</span>`).join(' ')}</div>`:''}
        `
        setStatus('Connected')
      }catch(e){
        $('#viewer').innerHTML = `<div class="danger">Cannot load message: ${e.message}</div>`
        setStatus('Error')
      }
    }

    $('#btnLoad').addEventListener('click', loadList)
    $('#btnCopy').addEventListener('click', ()=>{
      const alias = $('#alias').value.trim()
      const url = location.origin + location.pathname + `#/inbox/${encodeURIComponent(alias)}`
      navigator.clipboard.writeText(url).then(()=>{
        setStatus('Copied share URL')
        setTimeout(()=>setStatus('Connected'),1000)
      })
    })

    // auto init from URL hash
    window.addEventListener('load', ()=>{
      const a = aliasFromHash(); if(a){ $('#alias').value = a; loadList() }
    })
  </script>
</body>
</html>
